<!DOCTYPE html>
<html>

<head>
    <meta name='viewport' content='width=device-width' />
    <title>Flashcards</title>
    <link rel='icon' href='favicon.svg' />
    <link href='styles.css' rel='stylesheet' />
</head>

<body>
    <div style='display: flex; flex-direction: column; margin-top: 8px;'>
        <div style='display: flex; justify-content: center;'>
            <input id='character' onkeypress='getSelected(event)' style='font-size: 3.5em; width: 100%;'></input>
            <button onclick='toggleVisibility()' style='font-size: 3.5em;'>👀</button>
        </div>

        <div id='info'></div>

        <div style='display: flex; position: fixed; bottom: 0; left: 0; width: 100%;'>
            <button onclick='post(false)'
                style='width: 50%; border: none; background-color: red; font-size: 2.5em;'>👎🏻</button>
            <button onclick='post(true)'
                style='width: 50%; border: none; background-color: green; font-size: 2.5em;'>👍🏻</button>
        </div>
    </div>


    <script>
        let currentCharacter = '', infoVisible = false, isEditingSentence = false, isEditingWords = false

        const post = async (remembered) => {
            const headers = { 'Content-Type': 'application/json' }
            const body = JSON.stringify({ character: currentCharacter.hanzi, remembered })
            await fetch('/api/submission', { method: 'POST', headers, body })
            infoVisible = false
            await get('')
            history.pushState(currentCharacter.hanzi, '', `/#/${currentCharacter.hanzi}`)
        }

        const getSelected = (event) => {
            if (event.key === 'Enter') {
                get(document.getElementById('character').value)
            }
        }

        const get = async (character) => {
            const response = await fetch(`/api/character/${character}`)
            if (response.status === 200) {
                currentCharacter = await response.json()
                render()
            } else {
                alert('Error while loading')
            }
        }

        const renderInfoVisibility = () => {
            const setVisibility = (v) => document.getElementById('info').setAttribute('style', `visibility: ${v};`)
            return infoVisible ? setVisibility('visible') : setVisibility('hidden')
        }

        const tokenizerHtml = () => `<div class='tokenizer'><input type='text' id='tokenInput' onkeydown='createToken(event)' placeholder='Type and press ";" to create a token'></div>`

        const render = () => {
            document.getElementById('character').value = currentCharacter.hanzi
            const wordsLink = currentCharacter.words.map(w => `<a href=/words/#/${encodeURIComponent(w)}>${w}</a>`)
            const wordsTxt = currentCharacter.words
            const related = currentCharacter.related.map(w => `<a href=/#/${encodeURIComponent(w)}>${w}</a>`)
            renderInfoVisibility()
            // TODO support for other languages

            const sentencesHtmlDisplay = `<tr><td>Sentences</td><td style='color: red;''>不支持 (待定)<button onclick='edit_sentences()'>✎</button></td></tr>`
            // const sentencesHtmlEdit = `<tr><td>Sentences</td><td><input value='test'></input><button onclick='save_sentences()'>💾</button></td></tr>`
            const sentencesHtmlEdit = `<tr><td>Sentences</td><td>${tokenizerHtml()}<button onclick='save_sentences()'>💾</button></td></tr>`

            
            const sentencesHtml = isEditingSentence ? sentencesHtmlEdit : sentencesHtmlDisplay
            
            const wordsHtmlDisplay = `<tr><td>Words</td><td>${wordsLink}<button onclick='edit_words()'>✎</button></td></tr>`
            const wordsHtmlEdit = `<tr><td>Words</td><td><input value='${wordsTxt}'></input><button onclick='save_words()'>💾</button></td></tr>`
            const wordsHtml = isEditingWords ? wordsHtmlEdit : wordsHtmlDisplay

            document.getElementById('info').innerHTML = `
                <table style='width: calc(100% - 8px);'>
                    <tr><td>Pinyin</td><td>${currentCharacter.pinyin}</td></tr>
                    <tr><td>Radical</td><td>${currentCharacter.radical.hanzi} (${currentCharacter.radical.meaning})</td></tr>
                    <tr><td>Meaning</td><td>${currentCharacter.meaning}</td></tr>
                    ${wordsHtml}
                    ${sentencesHtml}
                    <tr><td>Related</td><td>${related}<button onclick='count()'>✎</button></td></tr>
                </table>
            `
        }

        function edit_sentences() {
            isEditingSentence=true
            render()
        }

        function save_sentences() {
            isEditingSentence=false
            render()
        }

        function edit_words() {
            isEditingWords=true
            render()
        }

        function save_words() {
            //TODO ... we need to save the words            
            isEditingWords=false 
            render()
        }
        
        const toggleVisibility = () => {
            infoVisible = !infoVisible
            renderInfoVisibility()
        }

        function createToken(event) {
            const tokenizer = event.target.parentElement
            if (event.key === ';') {
                event.preventDefault()
                const value = tokenInput.value.trim()
                if (value) {
                    appendTokenElementFor(value, tokenizer)
                    tokenInput.value = ''
                }
            } else if (event.key === 'Backspace' && tokenInput.selectionStart === 0) {
                const tokens = tokenizer.querySelectorAll('.token')
                if (tokens.length > 0) {
                    const lastToken = tokens[tokens.length - 1]
                    tokenizer.removeChild(lastToken)
                }
            }
        }

        function appendTokenElementFor(value, tokenizer) {
            const token = document.createElement('div')
            token.className = 'token'
            token.textContent = value

            const removeButton = document.createElement('span')
            removeButton.className = 'remove'
            removeButton.textContent = 'x'
            removeButton.addEventListener('click', () => {
                tokenizer.removeChild(token)
            })

            token.appendChild(removeButton)
            tokenizer.insertBefore(token, tokenInput)
        }

        window.onload = () => {
            window.addEventListener('hashchange', () => {
                get(window.location.hash.substring(2))
            })
        }

        if (window.location.hash.length > 0) {
            get(window.location.hash.substring(2))
        } else {
            get('')
        }
    </script>
</body>

</html>