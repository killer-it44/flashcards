<!DOCTYPE html>
<html>

<head>
    <meta name='viewport' content='width=device-width' />
    <title>Flashcards</title>
    <link rel='icon' href='favicon.svg' />
    <link href='styles.css' rel='stylesheet' />
</head>

<body>
    <script type='module'>
        import { html, render, useState, useEffect } from './preact-htm-standalone.js'

        const Modal = (props) => {
            const [expressions, setExpressions] = useState([{ expression: '', meaning: '' }])

            useEffect(() => {
                const firstInput = document.querySelector('.modal-content input[type="text"]')
                if (firstInput) firstInput.focus()
            }, [])

            const handleInputChange = (index, field, value) => {
                const updatedExpressions = [...expressions]
                updatedExpressions[index][field] = value
                setExpressions(updatedExpressions)

                // Add a new row if the current row is fully filled
                if (field === 'meaning' && value && updatedExpressions[index].expression) {
                    const hasEmptyRow = updatedExpressions.some(e => !e.expression && !e.meaning)
                    if (!hasEmptyRow) {
                        setExpressions([...updatedExpressions, { expression: '', meaning: '' }])
                    }
                }
            }

            const save = async () => {
                await props.onSave(expressions.filter(e => e.expression && e.meaning))
                props.onClose()
            }

            return html`
                <div class="modal-overlay" onclick=${props.onClose}>
                    <style>
                        .modal-overlay {
                            position: fixed;
                            top: 0;
                            left: 0;
                            width: 100%;
                            height: 100%;
                            background: rgba(0, 0, 0, 0.5);
                            display: flex;
                            justify-content: center;
                            align-items: center;
                        }

                        .modal-content {
                            background: white;
                            padding: 20px;
                            border-radius: 8px;
                            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
                            display: flex;
                            flex-direction: column;
                        }

                        .modal-content button {
                            background: #4CAF50;
                            color: white;
                            border: none;
                            padding: 10px 20px;
                            border-radius: 4px;
                            cursor: pointer;
                            font-weight: bold;
                        }

                        .modal-content button:hover {
                            background: #45a049;
                        }
                    </style>
                    <div class="modal-content" onclick=${(e) => e.stopPropagation()}>
                        <h3>Add Expressions</h3>
                        <table>
                            ${expressions.map((entry, index) => html`
                                <tr>
                                    <td>
                                        <input type='text' placeholder='Expression' value=${entry.expression || ''} oninput=${(e) => handleInputChange(index, 'expression', e.target.value)} />
                                    </td>
                                    <td>
                                        <input type='text' placeholder='Meaning' value=${entry.meaning || ''} oninput=${(e) => handleInputChange(index, 'meaning', e.target.value)} />
                                    </td>
                                </tr>
                            `)}
                        </table>
                        <button onclick=${save}>Save</button>
                    </div>
                </div>
            `
        }

        const Info = (props) => {
            const [isAddingExpressions, setAddingExpressions] = useState(false)
            const [isEditingRelated, setEditingRelated] = useState(false)
            const [related, setRelated] = useState(props.currentCharacter.related)

            const expressionsLinks = props.currentCharacter.words.map(w => html`<a href=/words/#/${encodeURIComponent(w)}>${w}</a>`)
            const expressionsLinksList = expressionsLinks.length > 0 ? expressionsLinks.reduce((prev, curr) => html`${prev}, ${curr}`) : html``

            const relatedLinks = props.currentCharacter.related.split(' ').map(w => html`<a href=/#/${encodeURIComponent(w)}>${w}</a>`)
            const relatedLinksList = relatedLinks.length > 0 ? relatedLinks.reduce((prev, curr) => html`${prev}, ${curr}`) : html``

            const saveRelated = async () => {
                await props.saveRelated(related)
                setEditingRelated(false)
            }

            const saveExpressions = async (expressions) => {
                const headers = { 'Content-Type': 'application/json' }
                const body = JSON.stringify(expressions)
                await fetch('/api/expressions', { method: 'POST', headers, body })
                await get(props.currentCharacter.hanzi)
            }

            return html`
                <table style='width: calc(100% - 8px);'>
                    <tr><td>Pinyin</td><td>${props.currentCharacter.pinyin}</td></tr>
                    <tr><td>Radical</td><td>${props.currentCharacter.radical.hanzi} (${props.currentCharacter.radical.meaning})</td></tr>
                    <tr><td>Meaning</td><td>${props.currentCharacter.meaning}</td></tr>
                    <tr><td>Expressions</td><td>${expressionsLinksList}<button onclick=${() => setAddingExpressions(true)}>Ôºã</button></td></tr>
                    ${isEditingRelated
                        ? html`<tr><td>Related</td><td><input oninput=${(event) => setRelated(event.target.value)} value=${related} /><button onclick=${saveRelated}>üíæ</button><button onclick=${() => setEditingRelated(false)}>‚ùå</button></td></tr>`
                        : html`<tr><td>Related</td><td>${relatedLinksList}<button onclick=${() => setEditingRelated(true)}>‚úé</button></td></tr>`
                    }
                    ${isAddingExpressions ? html`<${Modal} onClose=${() => setAddingExpressions(false)} onSave=${saveExpressions} />` : ''}
                </table>
            `
        }

        const App = () => {
            // TODO support for other languages
            const [isInfoVisible, setInfoVisible] = useState(false)
            const [currentCharacter, setCurrentCharacter] = useState({ pinyin: '', radical: { hanzi: '', meaning: '' }, meaning: '', words: [], related: [] })

            const getSelectedChar = (e) => (e.key === 'Enter') ? getChar(e.target.value) : null

            const getChar = async (hanzi) => setCurrentCharacter(await (await fetch(`/api/characters/${hanzi}`)).json())

            const toggleInfo = () => setInfoVisible(!isInfoVisible)

            const saveRelated = async (newRelated) => {
                const headers = { 'Content-Type': 'application/json' }
                const body = JSON.stringify({ ...currentCharacter, related: newRelated })
                await fetch(`/api/characters/${currentCharacter.hanzi}`, { method: 'PUT', headers, body })
                await getChar(props.currentCharacter.hanzi)
            }

            useEffect(() => getChar(''), [])

            return html`
                <div style='display: flex; flex-direction: column; margin-top: 8px;'>
                    <div style='display: flex; justify-content: center;'>
                        <input value=${currentCharacter.hanzi} onkeypress=${getSelectedChar} style='font-size: 3.5em; width: 100%;'></input>
                        <button onclick=${toggleInfo} style='font-size: 3.5em;'>üëÄ</button>
                    </div>
                    ${isInfoVisible ? html`<${Info} saveRelated=${saveRelated} currentCharacter=${currentCharacter} />` : ''}
                    <div style='display: flex; position: fixed; bottom: 0; left: 0; width: 100%;'>
                        <button onclick='post(false)'
                            style='width: 50%; border: none; background-color: red; font-size: 2.5em;'>üëéüèª</button>
                        <button onclick='post(true)'
                            style='width: 50%; border: none; background-color: green; font-size: 2.5em;'>üëçüèª</button>
                    </div>
                </div>
            `
        }

        render(html`<${App} />`, document.body)

        // const post = async (remembered) => {
        //     const headers = { 'Content-Type': 'application/json' }
        //     const body = JSON.stringify({ character: currentCharacter.hanzi, remembered })
        //     await fetch('/api/submissions', { method: 'POST', headers, body })
        //     infoVisible = false
        //     await get('')
        //     history.pushState(currentCharacter.hanzi, '', `/#/${currentCharacter.hanzi}`)
        // }
    </script>
</body>

</html>