<!DOCTYPE html>
<html>

<head>
    <meta name='viewport' content='width=device-width' />
    <title>Flashcards</title>
    <link rel='icon' href='favicon.svg' />
    <link href='styles.css' rel='stylesheet' />
</head>

<body>
    <div style='display: flex; flex-direction: column; margin-top: 8px;'>
        <div style='display: flex; justify-content: center;'>
            <input id='character' onkeypress='getSelected(event)' style='font-size: 3.5em; width: 100%;'></input>
            <button onclick='toggleVisibility()' style='font-size: 3.5em;'>👀</button>
        </div>

        <div id='info'></div>

        <div style='display: flex; position: fixed; bottom: 0; left: 0; width: 100%;'>
            <button onclick='post(false)'
                style='width: 50%; border: none; background-color: red; font-size: 2.5em;'>👎🏻</button>
            <button onclick='post(true)'
                style='width: 50%; border: none; background-color: green; font-size: 2.5em;'>👍🏻</button>
        </div>
    </div>


    <script>
        let currentCharacter = '', infoVisible = false

        const post = async (remembered) => {
            const headers = { 'Content-Type': 'application/json' }
            const body = JSON.stringify({ character: currentCharacter.hanzi, remembered })
            await fetch('/api/submission', { method: 'POST', headers, body })
            infoVisible = false
            await get('')
            history.pushState(currentCharacter.hanzi, '', `/#/${currentCharacter.hanzi}`)
        }

        const getSelected = (event) => {
            if (event.key === 'Enter') {
                get(document.getElementById('character').value)
            }
        }

        const get = async (character) => {
            const response = await fetch(`/api/character/${character}`)
            if (response.status === 200) {
                currentCharacter = await response.json()
                render()
            } else {
                alert('Error while loading')
            }
        }

        const renderInfoVisibility = () => {
            const setVisibility = (v) => document.getElementById('info').setAttribute('style', `visibility: ${v};`)
            return infoVisible ? setVisibility('visible') : setVisibility('hidden')
        }

        const render = () => {
            document.getElementById('character').value = currentCharacter.hanzi
            const words = currentCharacter.words.map(w => `<a href=/words/#/${encodeURIComponent(w)}>${w}</a>`)
            const related = currentCharacter.related.map(w => `<a href=/#/${encodeURIComponent(w)}>${w}</a>`)
            renderInfoVisibility()
            // TODO support for other languages
            document.getElementById('info').innerHTML = `
                <table style='width: calc(100% - 8px);'>
                    <tr><td>Pinyin</td><td>${currentCharacter.pinyin}</td></tr>
                    <tr><td>Radical</td><td>${currentCharacter.radical.hanzi} (${currentCharacter.radical.meaning})</td></tr>
                    <tr><td>Meaning</td><td>${currentCharacter.meaning}</td></tr>
                    <tr><td>Words</td><td>${words}</td><td><button onclick='edit()'>➕</button></td></tr>
                    <tr><td>Related</td><td>${related}</td><td><button onclick='edit()'>✎</button></td></tr>                
                </table>
            `
        }

        const toggleVisibility = () => {
            infoVisible = !infoVisible
            renderInfoVisibility()
        }

        window.onload = () => {
            window.addEventListener('hashchange', () => {
                get(window.location.hash.substring(2))
            })
        }

        if (window.location.hash.length > 0) {
            get(window.location.hash.substring(2))
        } else {
            get('')
        }
    </script>
</body>

</html>